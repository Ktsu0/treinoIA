<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campo Minado PRO | Treinamento de IA</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§ </text></svg>">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>

    <header>
        <h1>Campo Minado <span style="color: var(--ia-color)">Neuro-Core</span></h1>
    </header>

    <main>
        <div class="menu">
            <button onclick="startGame('facil')">FÃ¡cil (9x9)</button>
            <button onclick="startGame('medio')">MÃ©dio (16x16)</button>
            <button onclick="startGame('dificil')">DifÃ­cil (30x16)</button>
        </div>

        <div class="ai-controls">
            <button class="btn-ia" onclick="trainIA()">ğŸ§  Treinar IA</button>
            <button class="btn-ia" style="background: #e67e22;" onclick="trainWithCurriculum()">ğŸ“ Curriculum Learning</button>
            <button id="btn-genetic" class="btn-ia" style="background: #9b59b6;" onclick="startGeneticTraining()">ğŸ§¬ Escolinha GenÃ©tica</button>
            <button id="pause-btn" class="btn-pause" style="display:none" onclick="togglePause()">â¸ï¸ Pausar</button>
            <button class="btn-download" onclick="exportBrain()">ğŸ“¥ Baixar CÃ©rebro</button>
            <input type="file" id="brain-upload" accept=".json" style="display:none" onchange="importBrain(this.files[0])">
            <button class="btn-upload" onclick="document.getElementById('brain-upload').click()">ğŸ“¤ Carregar</button>
            <button class="btn-reset" onclick="resetBrain()">ğŸ—‘ï¸ Resetar</button>
            <label class="turbo-label">
                <input type="checkbox" id="turbo-mode"> ğŸš€ Modo Turbo
            </label>
            <div class="cpu-control">
                <label>âš¡ CPU: <span id="cpu-val">20</span></label>
                <input type="range" id="cpu-slider" min="1" max="100" value="20" oninput="CPU_INTENSITY = this.value; document.getElementById('cpu-val').innerText = this.value">
            </div>
        </div>

        <div class="stats-bar">
            <div id="stat-timer">â±ï¸ <span id="timer">0</span>s</div>
            <div id="stat-mines">ğŸ’£ <span id="mine-count">0</span></div>
            <div id="ia-status">Modo: Humano</div>
        </div>


        <div class="training-progress">
            <div class="progress-fill"></div>
        </div>

        <div class="training-stats">
            <div class="stat-item">
                <span class="stat-label">Ciclos</span>
                <span class="stat-value" id="cycle-count">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">VitÃ³rias</span>
                <span class="stat-value" id="win-count">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Taxa</span>
                <span class="stat-value" id="win-rate">0%</span>
            </div>
        </div>

        <div id="grid"></div>

        <div class="ranking-container">
            <h3 style="margin: 0; text-align: center; color: var(--secondary)">
                ğŸ† Melhores Tempos - <span id="diff-label">FÃCIL</span>
            </h3>
            <table id="leaderboard">
                <thead>
                    <tr>
                        <th>PosiÃ§Ã£o</th>
                        <th>Tempo</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="3">Sem recordes ainda</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal de Resultado -->
    <div id="modal-overlay" class="overlay">
        <div id="modal-content" class="modal">
            <h2 id="modal-title">Resultado</h2>
            <p id="modal-msg"></p>
            <button onclick="closeModal()">Jogar Novamente</button>
        </div>
    </div>

    <!-- Bibliotecas e Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0"></script>
    <script src="game.js"></script>
    <script src="ia.js"></script>
    <script src="genetic.js"></script>
    <script src="curriculum.js"></script>
    
    <script>
        // InicializaÃ§Ã£o
        window.onload = async () => {
            startGame('facil');
            
            let loaded = false;
            
            // 1. Tenta carregar brain-data.json do projeto (PRIORIDADE)
            // O usuÃ¡rio quer que o JSON seja a fonte da verdade, mas mantendo o LocalStorage atualizado
            try {
                console.log("ğŸ“‚ Tentando carregar brain-data.json...");
                // Adicionando timestamp para evitar cache do navegador
                const response = await fetch('brain-data.json?t=' + new Date().getTime());
                
                if (response.ok) {
                    const brainData = await response.json();
                    
                    if (brainData.modelTopology && brainData.weights && brainData.weights.length > 0) {
                        // Recria o cÃ©rebro com as dimensÃµes corretas
                        aiBrain = new MinesweeperAI(brainData.metadata.rows, brainData.metadata.cols);
                        
                        // Restaura metadados
                        aiBrain.epsilon = brainData.metadata.epsilon;
                        currentCycle = brainData.metadata.currentCycle || 0;
                        totalWins = brainData.metadata.totalWins || 0;
                        
                        // Restaura pesos do modelo
                        const weightValues = brainData.weights.map(w => {
                            if (w.shape && w.data) {
                                // Novo formato com shape
                                return tf.tensor(w.data, w.shape);
                            } else {
                                // Formato antigo (compatibilidade)
                                return tf.tensor(w);
                            }
                        });
                        aiBrain.model.setWeights(weightValues);
                        weightValues.forEach(w => w.dispose());
                        
                        // CRÃTICO: Recompila o modelo apÃ³s carregar os pesos
                        aiBrain.model.compile({
                            optimizer: tf.train.adam(aiBrain.learningRate),
                            loss: "meanSquaredError",
                        });
                        
                        updateStats();
                        document.getElementById('ia-status').innerText = `CÃ©rebro do Projeto Carregado! (${currentCycle} ciclos)`;
                        console.log("âœ… Modelo carregado de brain-data.json!");
                        console.log(`ğŸ“Š Ciclos: ${currentCycle} | VitÃ³rias: ${totalWins}`);
                        
                        // Sincroniza com o LocalStorage imediatamente
                        await saveBrainToStorage();
                        console.log("ğŸ”„ Sincronizado com LocalStorage");
                        
                        loaded = true;
                    }
                }
            } catch(e) {
                console.log("â„¹ï¸ brain-data.json nÃ£o encontrado ou invÃ¡lido. Tentando LocalStorage...", e);
            }
            
            // 2. Se falhar o JSON, tenta carregar do LocalStorage
            if (!loaded) {
                try {
                    const savedModel = await tf.loadLayersModel('localstorage://minesweeper-model');
                    const metadata = JSON.parse(localStorage.getItem('minesweeper-metadata') || '{}');
                    
                    if(savedModel && metadata) {
                        aiBrain.model = savedModel;
                        // âœ… Garante epsilon mÃ­nimo de 0.2 para continuar explorando
                        aiBrain.epsilon = Math.max(metadata.epsilon || 0.2, 0.2);
                        currentCycle = metadata.currentCycle || 0;
                        totalWins = metadata.totalWins || 0;
                        
                        updateStats();
                        document.getElementById('ia-status').innerText = `CÃ©rebro Carregado! (${currentCycle} ciclos)`;
                        console.log("âœ… Modelo carregado do LocalStorage!");
                        console.log(`ğŸ“Š Ciclos: ${currentCycle} | VitÃ³rias: ${totalWins}`);
                        console.log(`ğŸ”„ Epsilon ajustado para: ${aiBrain.epsilon.toFixed(3)} (mÃ­n: 0.2)`);
                        loaded = true;
                    }
                } catch(e) {
                    console.log("â„¹ï¸ LocalStorage vazio ou erro ao carregar.");
                }
            }
            
            // Mostra painel de estatÃ­sticas se houver dados
            if (currentCycle > 0) {
                document.querySelector('.training-stats').classList.add('active');
            }
        };
    </script>
</body>
</html>