<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Campo Minado PRO + IA</title>
        <style>
        :root {
            --primary: #4a69bd;
            --secondary: #1e3799;
            --bg: #f0f2f5;
            --cell-bg: #d1d8e0;
            --cell-rev: #ffffff;
            --danger: #eb4d4b;
            --success: #6ab04c;
            --ia-color: #8e44ad;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            color: #2f3542;
        }

        h1 { margin-bottom: 10px; color: var(--secondary); text-transform: uppercase; letter-spacing: 2px; }

        .menu { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:hover { background: var(--secondary); transform: translateY(-2px); }
        
        .btn-ia { background: var(--ia-color); }
        .btn-ia:hover { background: #6c5ce7; }

        .stats-bar {
            display: flex;
            gap: 20px;
            background: white;
            padding: 15px 30px;
            border-radius: 50px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            font-size: 1.1rem;
        }

        #grid {
            display: grid;
            gap: 4px;
            padding: 10px;
            background: #a5b1c2;
            border-radius: 8px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .cell {
            width: 35px;
            height: 35px;
            background: var(--cell-bg);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            cursor: pointer;
            transition: background 0.1s;
        }

        .cell.revealed { background: var(--cell-rev); box-shadow: none; cursor: default; }
        .cell.mine { background: var(--danger); }
        .cell.flagged { color: #eb4d4b; }
        .cell.ia-target { outline: 3px solid var(--ia-color); z-index: 10; }

        .n1 { color: #2980b9; } .n2 { color: #27ae60; } .n3 { color: #e67e22; }
        .n4 { color: #8e44ad; } .n5 { color: #c0392b; }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none;
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal {
            background: white; padding: 30px; border-radius: 15px;
            text-align: center; max-width: 400px; width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .ranking-container {
            width: 100%; max-width: 500px; background: white;
            padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }

        #ia-status {
            margin-top: 10px;
            font-weight: bold;
            color: var(--ia-color);
        }
    </style>
    </head>
    <body>

        <h1>Campo Minado <span style="color: var(--ia-color)">AI
                Edition</span></h1>

        <div class="menu">
            <button onclick="startGame('facil')">F√°cil</button>
            <button onclick="startGame('medio')">M√©dio</button>
            <button onclick="startGame('dificil')">Dif√≠cil</button>
            <button class="btn-ia" onclick="trainIA()">üß† Treinar IA </button>
        </div>

        <div class="stats-bar">
            <span>‚è±Ô∏è <span id="timer">0</span>s</span>
            <span>üí£ <span id="mine-count">0</span></span>
            <span id="ia-status">Modo: Humano</span>
        </div>

        <div id="grid"></div>

        <div class="ranking-container">
            <h3 style="margin: 0; text-align: center;">üèÜ Top 10 (<span
                    id="diff-label">-</span>)</h3>
            <table id="leaderboard">
                <thead><tr><th>Pos</th><th>Tempo</th><th>Data</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="modal-overlay" class="overlay">
            <div id="modal-content" class="modal">
                <h2 id="modal-title">Resultado</h2>
                <p id="modal-msg"></p>
                <button onclick="closeModal()">OK</button>
            </div>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0"></script>

        <script>
let board = [], rows, cols, mines, timerInterval, seconds = 0, isGameOver = false, activeDiff = '';
let trainingMode = false;

const config = {
    facil: { r: 9, c: 9, m: 10 },
    medio: { r: 16, c: 16, m: 40 },
    dificil: { r: 16, c: 30, m: 99 }
};

// --- L√ìGICA DO JOGO ---
function startGame(level) {
    activeDiff = level;
    const c = config[level];
    rows = c.r; cols = c.c; mines = c.m;
    document.getElementById('diff-label').innerText = level.toUpperCase();
    resetGame();
    renderRanking();
    if(!trainingMode) closeModal();
}

function resetGame() {
    clearInterval(timerInterval);
    seconds = 0; isGameOver = false;
    document.getElementById('timer').innerText = "0";
    document.getElementById('mine-count').innerText = mines;
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    grid.style.gridTemplateColumns = `repeat(${cols}, 35px)`;

    board = Array.from({ length: rows }, () => 
        Array.from({ length: cols }, () => ({ mine: false, revealed: false, flagged: false, count: 0 }))
    );

    let mPlanted = 0;
    while(mPlanted < mines) {
        let r = Math.floor(Math.random()*rows), c = Math.floor(Math.random()*cols);
        if(!board[r][c].mine) { board[r][c].mine = true; mPlanted++; }
    }

    for(let r=0; r<rows; r++) {
        for(let c=0; c<cols; c++) {
            if(board[r][c].mine) continue;
            let count = 0;
            for(let i=-1; i<=1; i++) {
                for(let j=-1; j<=1; j++) if(board[r+i]?.[c+j]?.mine) count++;
            }
            board[r][c].count = count;
        }
    }

    for(let r=0; r<rows; r++) {
        for(let c=0; c<cols; c++) {
            const el = document.createElement('div');
            el.classList.add('cell');
            el.id = `cell-${r}-${c}`;
            el.addEventListener('click', () => handleClick(r, c));
            el.addEventListener('contextmenu', (e) => { e.preventDefault(); handleRightClick(r, c); });
            grid.appendChild(el);
        }
    }
}

// FUN√á√ÉO QUE FALTAVA NO SEU C√ìDIGO
function handleRightClick(r, c) {
    if (isGameOver || board[r][c].revealed) return;
    const el = document.getElementById(`cell-${r}-${c}`);
    board[r][c].flagged = !board[r][c].flagged;
    el.classList.toggle('flagged');
    el.innerText = board[r][c].flagged ? "üö©" : "";
}

function handleClick(r, c) {
    if(isGameOver || board[r][c].revealed || board[r][c].flagged) return "invalid";
    if(seconds === 0) startTimer();

    if(board[r][c].mine) {
        revealAllMines();
        if(!trainingMode) showModal('lose');
        return "mine";
    }

    reveal(r, c);
    if(checkWin()) {
        if(!trainingMode) showModal('win');
        return "win";
    }
    return "safe";
}

function reveal(r, c) {
    if(r<0 || r>=rows || c<0 || c>=cols || board[r][c].revealed) return;
    board[r][c].revealed = true;
    const el = document.getElementById(`cell-${r}-${c}`);
    if(el) {
        el.classList.add('revealed');
        if(board[r][c].count > 0) {
            el.innerText = board[r][c].count;
            el.classList.add(`n${board[r][c].count}`);
        } else {
            for(let i=-1; i<=1; i++) {
                for(let j=-1; j<=1; j++) reveal(r+i, c+j);
            }
        }
    }
}

function checkWin() {
    const revealed = board.flat().filter(c => c.revealed).length;
    if(revealed === (rows * cols) - mines) {
        isGameOver = true;
        clearInterval(timerInterval);
        return true;
    }
    return false;
}

function revealAllMines() {
    isGameOver = true;
    clearInterval(timerInterval);
    board.forEach((row, r) => row.forEach((cell, c) => {
        if(cell.mine) {
            const el = document.getElementById(`cell-${r}-${c}`);
            if(el) { el.classList.add('mine'); el.innerText = "üí£"; }
        }
    }));
}

function startTimer() { timerInterval = setInterval(() => { seconds++; document.getElementById('timer').innerText = seconds; }, 1000); }
function showModal(type) { 
    document.getElementById('modal-overlay').style.display = 'flex';
    document.getElementById('modal-title').innerText = type === 'win' ? "üî• VIT√ìRIA!" : "üí• BUM!";
    document.getElementById('modal-msg').innerText = type === 'win' ? `Tempo: ${seconds}s` : "Tente novamente!";
}
function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; if(isGameOver) resetGame(); }
function renderRanking() { /* Sua l√≥gica de ranking */ }

// --- IA CORRIGIDA ---
class MinesweeperBrain {
    constructor() {
        this.model = tf.sequential();
        // Camada 1: Entrada (81 c√©lulas) -> Escondida (128 neur√¥nios)
        this.model.add(tf.layers.dense({ units: 128, activation: 'relu', inputShape: [81] }));
        // Camada 2: Escondida (64 neur√¥nios)
        this.model.add(tf.layers.dense({ units: 64, activation: 'relu' }));
        // Camada 3: Sa√≠da (162 a√ß√µes poss√≠veis: 81 cliques + 81 bandeiras)
        this.model.add(tf.layers.dense({ units: 162, activation: 'linear' }));
        
        this.model.compile({ optimizer: 'adam', loss: 'meanSquaredError' });
    }

    getState() {
    return board.flat().map(c => {
        if (c.revealed) return c.count / 8; // V√™ o n√∫mero (0 a 1)
        if (c.flagged) return 1;            // V√™ a bandeira como valor m√°ximo
        return -1;                          // V√™ como fechado
    });
}

    async predictAction(state) {
        return tf.tidy(() => {
            const prediction = this.model.predict(tf.tensor2d([state]));
            return prediction.argMax(-1).dataSync()[0];
        });
    }
}

const brain = new MinesweeperBrain();

async function trainIA() {
    trainingMode = true;
    const statusEl = document.getElementById('ia-status');
    let epsilon = 0.5; // Chance inicial de chutar aleatoriamente
    
    let statesBuffer = [];
    let targetsBuffer = [];

    for(let i = 0; i < 200; i++) {
        statusEl.innerText = `Ciclo ${i+1}/200 (Treinando Lote)`;
        startGame('facil');
        let episodeReward = 0;

        while(!isGameOver) {
            const state = brain.getState();
            let actionIdx;

            // Decis√£o (IA decide o que fazer)
            if (Math.random() < epsilon) {
                actionIdx = Math.floor(Math.random() * 162);
            } else {
                const prediction = brain.model.predict(tf.tensor2d([state]));
                const data = await prediction.data();
                actionIdx = data.indexOf(Math.max(...data));
            }

            // Identifica se √© clique ou bandeira
            const isFlagAction = actionIdx >= 81;
            const targetCellIdx = isFlagAction ? actionIdx - 81 : actionIdx;
            const r = Math.floor(targetCellIdx / 9);
            const c = targetCellIdx % 9;
            
            let reward = 0;
            const cell = board[r][c];

            // EXECU√á√ÉO E RECOMPENSA
            if (isFlagAction) {
                if (cell.revealed || cell.flagged) {
                    reward = -10; 
                } else {
                    handleRightClick(r, c);
                    reward = cell.mine ? 15 : -10;
                }
            } else {
                let result = handleClick(r, c);
                if(result === "mine") reward = -12;
                else if(result === "safe") reward = 4;
                else if(result === "win") reward = 50;
                else reward = -5;
            }

            // PREPARA√á√ÉO DO TREINO (COLETA DE DADOS)
            const currentPredictions = brain.model.predict(tf.tensor2d([state]));
            const labelsArray = Array.from(await currentPredictions.data());
            labelsArray[actionIdx] = reward;

            statesBuffer.push(state);
            targetsBuffer.push(labelsArray);

            // TREINAMENTO EM LOTE (A m√°gica acontece aqui)
            if (statesBuffer.length >= 32) {
                const xs = tf.tensor2d(statesBuffer);
                const ys = tf.tensor2d(targetsBuffer);
                await brain.model.fit(xs, ys, { epochs: 1, verbose: 0 });
                
                statesBuffer = [];
                targetsBuffer = [];
                xs.dispose();
                ys.dispose();
            }

            episodeReward += reward;
            await new Promise(res => setTimeout(res, 1)); // Velocidade m√°xima
        }
        // Reduz epsilon: ela chuta menos e usa mais o c√©rebro com o tempo
        epsilon = Math.max(0.01, epsilon * 0.95);
        console.log(`Ciclo ${i+1} finalizado. Epsilon: ${epsilon.toFixed(2)}`);
    }
    statusEl.innerText = "IA Treinada!";
    trainingMode = false;
}
startGame('facil');
</script>
    </body>
</html>